<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.itrip.prj.cbtGuide.mapper.CbtGuideMapper">

	<!-- List<CbtGuideVO> cbtGuideList();//전체조회(R) -->
	<select id="cbtGuideList" resultType="co.itrip.prj.cbtGuide.service.CbtGuideVO">
	    SELECT * FROM CBT_GUIDE
	</select>
	
	<!-- List<CbtGuideVO> cbtGuideListTab(CbtGuideVO vo); //탭 클릭시 유형별, 언어별로 조회 -->
	<select id="cbtGuideListTab" parameterType="co.itrip.prj.cbtGuide.service.CbtGuideVO" resultType="co.itrip.prj.cbtGuide.service.CbtGuideVO">
        <if test="gtpCd==4">
	        SELECT G.CBT_NO,G.QUES,G.LANG_CD, G.CNSR, G.EX1, G.EX2, 
		    	   G.EX3, G.EX4, G.ATTACH, G.ATTACH_DIR, G.CNSR_CNT, G.CALL, 
		    	   G.EXPLNA, G.GTP_CD, G.MEMBER_ID
			FROM (SELECT ROWNUM AS ROWNO, CBT_NO,QUES,LANG_CD, CNSR, 
			             EX1, EX2, EX3, EX4, ATTACH, ATTACH_DIR, CNSR_CNT, 
			             CALL, EXPLNA, GTP_CD, MEMBER_ID  
			      FROM CBT_GUIDE WHERE GTP_CD IN('1','2') AND LANG_CD=#{langCd}) G
			WHERE G.ROWNO BETWEEN 1 and 5
		</if>
		<if test="gtpCd!=4">
			SELECT G.CBT_NO,G.QUES,G.LANG_CD, G.CNSR, G.EX1, G.EX2, 
		    	   G.EX3, G.EX4, G.ATTACH, G.ATTACH_DIR, G.CNSR_CNT, G.CALL, 
		    	   G.EXPLNA, G.GTP_CD, G.MEMBER_ID
			FROM (SELECT ROWNUM AS ROWNO, CBT_NO,QUES,LANG_CD, CNSR, 
			             EX1, EX2, EX3, EX4, ATTACH, ATTACH_DIR, CNSR_CNT, 
			             CALL, EXPLNA, GTP_CD, MEMBER_ID  
			      FROM CBT_GUIDE WHERE  GTP_CD=#{gtpCd} AND LANG_CD=#{langCd}) G
			WHERE G.ROWNO BETWEEN 1 and 5
	    </if>
	</select>
	
	<!-- public CbtGuideVO ajaxExplnaList(CbtGuideVO VO); // 풀이 단건 리스트 -->
	<select id="ajaxExplnaList" parameterType="co.itrip.prj.cbtGuide.service.CbtGuideVO" resultType="co.itrip.prj.cbtGuide.service.CbtGuideVO">
	    SELECT * FROM CBT_GUIDE WHERE CBT_NO = ${cbtNo}
	</select>
	
	
	<!-- CbtGuideVO cbtGuideListOne(CbtGuideVO VO);//단건조회(R) -->
	<select id="cbtGuideListOne" parameterType="co.itrip.prj.cbtGuide.service.CbtGuideVO" resultType="co.itrip.prj.cbtGuide.service.CbtGuideVO">
	    SELECT * FROM CBT_GUIDE WHERE CBT_NO = ${cbtNo}
	</select>
	
	<!-- public int cbtGuideInsert(CbtGuideVO VO); //등록(C) -->
	<insert id="cbtGuideInsert" >
	
	   <selectKey keyProperty="cbtNo" order="BEFORE" resultType="int">
			SELECT NVL(MAX(CBT_NO),0) + 1
			FROM CBT_GUIDE
		</selectKey>
		insert into cbt_guide values(#{cbtNo},#{ques},#{cnsr, jdbcType=VARCHAR},#{ex1, jdbcType=VARCHAR},
		            #{ex2, jdbcType=VARCHAR},#{ex3, jdbcType=VARCHAR},#{ex4, jdbcType=VARCHAR},
                    #{attach, jdbcType=VARCHAR},#{attachDir, jdbcType=VARCHAR},0,0,#{explna},#{gtpCd},#{langCd},#{memberId , jdbcType=VARCHAR})
	</insert>
	
	<insert id="KeywordInsert" parameterType="co.itrip.prj.cbtGuide.service.CbtKeywordVO">
	    <selectKey keyProperty="kyNo" order="BEFORE" resultType="int">
			SELECT CASE WHEN MAX(KY_NO) IS NULL THEN 1 
				   ELSE  MAX(KY_NO)+1 END ID 
			FROM CBT_KEYWORD
		</selectKey>
	    insert into cbt_keyword values( #{kyNo} , #{cKwrd} , ${cbtNo})    
	</insert>
	
	<!-- public int cbtGuideUpdate(CbtGuideVO VO); //수정(U) -->
	<update id="cbtGuideUpdate">
	</update>
	
	<!-- public int cbutGuideDelet(CbtGuideVO VO);//삭제(D) -->
	<delete id="cbutGuideDelet">
	</delete>
	<!-- public MyCbtHderVO myCbtHderInsert(MyCbtHderVO vo); // myCBtHder에 담기 -->
	<insert id="myCbtHderInsert" parameterType="co.itrip.prj.cbtGuide.service.MyCbtHderVO">
	    <selectKey keyProperty="mcNo" order="BEFORE" resultType="int">
			SELECT CASE WHEN MAX(MC_NO) IS NULL THEN 1 
				   ELSE  MAX(MC_NO)+1 END MC_NO
			FROM MYCBT_HDER
		</selectKey>
		INSERT INTO MYCBT_HDER (MC_NO, MEMBER_ID, DT, GTP_CD, LANG_CD,
							CBT_NO1, CBT_NO2, CBT_NO3, CBT_NO4, CBT_NO5,    
							CNSR1, CNSR2, CNSR3, CNSR4, CNSR5)
		VALUES(#{mcNo},#{memberId},SYSDATE,#{gtpCd},#{langCd},
		       #{cbtNo1}, #{cbtNo2}, #{cbtNo3}, #{cbtNo4}, #{cbtNo5},    
			   #{cnsr1}, #{cnsr2}, #{cnsr3}, #{cnsr4}, #{cnsr5})
	</insert>
	
	<!-- public int myCbtHderChkUpdate(MyCbtHderVO vo); // myCbtHder의 내용을 비교하여 정답 체크 -->
	<update id="myCbtHderChkUpdate">
	    update mycbt_hder set CHK1 =  case when( SELECT cnsr FROM cbt_guide WHERE cbt_no = mycbt_hder.cbt_no1 )=(select cnsr1 from mycbt_hder where mc_no= ${mcNo}) then 1 else 0 end,
		                      CHK2 =  case when( SELECT cnsr FROM cbt_guide WHERE cbt_no = mycbt_hder.cbt_no2 )=(select cnsr1 from mycbt_hder where mc_no= ${mcNo}) then 1 else 0 end,
		                      CHK3 =  case when( SELECT cnsr FROM cbt_guide WHERE cbt_no = mycbt_hder.cbt_no3 )=(select cnsr1 from mycbt_hder where mc_no= ${mcNo}) then 1 else 0 end,
		                      CHK4 =  case when( SELECT cnsr FROM cbt_guide WHERE cbt_no = mycbt_hder.cbt_no4 )=(select cnsr1 from mycbt_hder where mc_no= ${mcNo}) then 1 else 0 end,
		                      CHK5 =  case when( SELECT cnsr FROM cbt_guide WHERE cbt_no = mycbt_hder.cbt_no5 )=(select cnsr1 from mycbt_hder where mc_no= ${mcNo}) then 1 else 0 end  where mc_no =${mcNo}
	</update>
	<!-- public int KeywordList(); -->
	<!--  MyCbtHderVO myCbtHderList(MyCbtHderVO vo); //myCbtHder 단건 조회-->
	<select id="myCbtHderList" parameterType="co.itrip.prj.cbtGuide.service.MyCbtHderVO" resultType="co.itrip.prj.cbtGuide.service.MyCbtHderVO">
	    SELECT * FROM mycbt_hder WHERE mc_no= ${mcNo}
	</select>
	
	<!--  public int chkCuntUpdate(MyCbtHderVO vo); //맞은 카운트 조회-->
	<update id="chkCuntUpdate">
	    update mycbt_hder set chk0_cunt = (select 5-(chk1+chk2+chk3+chk4+chk5) from mycbt_hder where mc_no= ${mcNo}), chk1_cunt = (select chk1+chk2+chk3+chk4+chk5 from mycbt_hder where mc_no= ${mcNo}) where mc_no= ${mcNo}
	</update>
	
	<!-- List<Map<Integer,Object>> cbtGuideListFive(CbtGuideVO vo);//내가 푼거 5개만 한번에 찾기(채점된 문제 출력용)  -->
	<select id="cbtGuideListFive">
	    select * from cbt_guide where cbt_no in (${cbtNo1},${cbtNo2},${cbtNo3},${cbtNo4},${cbtNo5});
	</select>
	
</mapper>