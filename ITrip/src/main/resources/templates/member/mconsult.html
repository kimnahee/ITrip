<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="author" content="Untree.co" />
<meta name="description" content="" />
<meta name="keywords" content="bootstrap, bootstrap5" />
<title>User MyConsult</title>
<style>
.table {
	text-align: center;
	margin-top: 50px;
	margin-bottom: 50px;
}

.table td img {
	max-width: 100%;
}

.alert {
	position: relative;
	padding: 2rem 2rem;
	margin-bottom: 1rem;
	border: none solid transparent;
	border-radius: 0.25rem;
	font-size: 1.6rem;
}
</style>
</head>
<body>
	<div layout:fragment="content">
		<div class="card">
			<input type="hidden" id="memberId"
				th:value="${#authentication.principal.member.memberId}" />
			<div class="alert alert-light-primary color-primary">My Consult</div>
			<div class="card-body">
			
				<!-- 결제한 상담이 없을 때 -->
				<div class="row" th:if="${#lists.isEmpty(consultList)}">
					<table class="table">
						<tr>
							<td><h3 class='error-title'>진행중인 상담이 없습니다.</h3>
								<br>
							<h4>새로운 상담을 신청해주세요.</h4></td>
						</tr>
						<tr>
							<td>Go Mypage</td>
						</tr>
					</table>
				</div>
				
				<!-- 결제한 상담이 있을 때 -->
				<div class="row" th:unless="${#lists.isEmpty(consultList)}">
					<div th:each="con : ${consultList}" style="width: 380px;">
					
					 <!-- 상담이 진행중일 때 -->
						<div th:if="${con.st == '진행중'}">
							<table class="table table-bordered" style="width: 350px;">
								<tr style="display: none;">
									<td th:text="${con.consultNo}"></td>
								</tr>
								<tr>
									<td th:text="${con.title}"></td>
								</tr>
								<tr>
									<td th:text="${con.st}"></td>
								</tr>
								<tr>
									<td th:text="'가이드  / '+${con.guideId}"></td>
								</tr>
								<tr>
									<td th:text="'상담일, 시작시간 /'+${con.conday}+', '+${con.stime}"></td>
								</tr>
								<tr>
									<td><div>
								상담시간입니다.<br>
	              							아래 채팅창을 눌러 가이드와 상담을 하실 수 있습니다.
									</div></td>
								</tr>
								<tr>
									<td>
										<button class="btn btn-primary py-2 px-3 consultChat">채팅방</button>
									</td>
								</tr>
							</table>
						</div>
						
						<!-- 상담이 진행전일 때 -->
						<div th:if="${con.st == '진행전'}">
							<table class="table table-bordered" style="width: 350px;">
								<tr style="display: none;">
									<td th:text="${con.consultNo}"></td>
								</tr>
								<tr>
									<td th:text="${con.title}"></td>
								</tr>
								<tr>
									<td th:text="${con.st}"></td>
								</tr>
								<tr>
									<td th:text="'가이드  / '+${con.guideId}"></td>
								</tr>
								<tr>
									<td th:text="'상담일, 시작시간 /'+${con.conday}+', '+${con.stime}"></td>
								</tr>
								<tr>
									<td><div>
								아직 상담시간이 되지 않았습니다.<br>
	              							문의 할 점이 있으시면 아래로 문의 부탁드립니다.
									</div></td>
								</tr>
								<tr>
									<td>
									<button class="btn btn-primary py-2 px-3 qnaList">Q&A</button>
									</td>
								</tr>
							</table>
						</div>
						
						<!-- 상담이 개설전일 때 -->
						<div th:if="${con.st == '개설전'}">
							<table class="table table-bordered" style="width: 350px;">
								<tr style="display: none;">
									<td th:text="${con.consultNo}"></td>
								</tr>
								<tr>
									<td th:text="${con.title}"></td>
								</tr>
								<tr>
									<td th:text="${con.st}"></td>
								</tr>
								<tr>
									<td th:text="'가이드  / '+${con.guideId}"></td>
								</tr>
								<tr>
									<td th:text="'상담일, 시작시간 /'+${con.conday}+', '+${con.stime}"></td>
								</tr>
								<tr>
									<td><div>
								아직 상담일자가 되지 않았습니다.<br>
	              							문의 할 점이 있으시면 아래로 문의 부탁드립니다.
									</div></td>
								</tr>
								<tr>
									<td>
									<button class="btn btn-primary py-2 px-3 qnaList">Q&A</button>
									</td>
								</tr>
							</table>
						</div>
						
						<!-- 상담이 종료되었을 때 -->
						<div th:if="${con.st == '종료'}">
							<table class="table table-bordered" style="width: 350px;">
								<tr style="display: none;">
									<td th:text="${con.consultNo}"></td>
								</tr>
								<tr>
									<td th:text="${con.title}"></td>
								</tr>
								<tr>
									<td th:text="${con.st}"></td>
								</tr>
								<tr>
									<td th:text="'가이드  / '+${con.guideId}"></td>
								</tr>
								<tr>
									<td th:text="'상담일, 시작시간 /'+${con.conday}+', '+${con.stime}"></td>
								</tr>
								<tr>
									<td><div>
								종료된 상담입니다.<br>
											상담가능시간은 상담시작시간으로부터 1시간입니다.<br>
	              							다시 상담내용을 보고 싶다면 아래 버튼을 눌러주세요.
									</div></td>
								</tr>
								<tr>
									<td>
	              							<form class="token" action="conReview" method="post">
							                		<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
							                      	<input name="guideId" id="guideId" th:value="${con.guideId}" type="hidden">
							                      	<input name="no" class="no" id="no" th:value="${con.consultNo}" type="hidden">
							                      	<button type="button" class="btn btn-primary py-2 px-3 consultChat">상담내용</button>
							                      	<button type="button" class="btn btn-primary py-2 px-3 consultReview">리뷰</button>
							                </form>
									</td>
								</tr>
							</table>
						</div>
						
						
					</div>
				</div>
			</div>
		</div>
		<script>
			//채팅방 연결
			let token = $("meta[name='_csrf']").attr("content");
			
			$(".consultChat").on("click", function(e) {
				let consultNo = $(e.target).parent().parent().parent().prev().prev().prev().prev().prev().prev().children(0).html();
				console.log(consultNo);
				//let memberId = $("#memberId").val();
				//console.log(memberId);
				location.href="/consultChat.do?consultNo="+consultNo;
			})
			
			$(".consultReview").on("click", function(e){
				let cNum = $(e.target).parent().parent().parent().prev().prev().prev().prev().prev().prev().children(0).html();
				console.log(cNum);
				let frm = $(".token");
	 			 $.ajax({
	 				url : "/consultReviewSelect.do",
	 				type : "get",
	 				data : {'no' : cNum},
	 				beforeSend :function(xhr) {
	 					xhr.setRequestHeader("AJAX", true);
	 			    	xhr.setRequestHeader("X-CSRF-TOKEN", token);
	 				},
	 				success : function(data) {
	 					console.log("출력" + data);
	 					
	 					 if(data.reviewNo != null) {
	 					   alert("이미 리뷰를 작성한 상담입니다.");
	 					   console.log($(e.target));
	 					} else {
	 					//	$(e.target).one("click", submit);
	 						frm.submit();
	 					}
	 				}
	 				
	 				})
				//리뷰 상태체크
				//location.href="/conReview";
			})

			$(".qnaList").on("click", function(e) {
				location.href = "/qnaList.do";
			})
			
			//리뷰버튼 상태체크
		</script>
	</div>

</body>
</html>