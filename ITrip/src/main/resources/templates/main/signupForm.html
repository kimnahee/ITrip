<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">
<head>
<meta charset="utf-8" />
<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="apple-touch-icon" sizes="76x76"
	href="bootstrap/material/assets/img/apple-icon.png">
<link rel="icon" type="image/png" href="bootstrap/material/assets/img/favicon.png">
<title>회원가입</title>
<script src="js/jquery-3.6.0.min.js"></script>
<!--     Fonts and icons     -->
<link rel="stylesheet" type="text/css"
	href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,900|Roboto+Slab:400,700" />
<!-- Nucleo Icons -->
<link href="bootstrap/material/assets/css/nucleo-icons.css" rel="stylesheet" />
<link href="bootstrap/material/assets/css/nucleo-svg.css" rel="stylesheet" />
<!-- Font Awesome Icons -->
<script src="https://kit.fontawesome.com/42d5adcbca.js"
	crossorigin="anonymous"></script>
<!-- Material Icons -->
<link
	href="https://fonts.googleapis.com/icon?family=Material+Icons+Round"
	rel="stylesheet">
<!-- CSS Files -->
<link id="pagestyle" href="bootstrap/material/assets/css/material-dashboard.css?v=3.0.0"
	rel="stylesheet" />
</head>

<body layout:fragment="content">
	<main class="main-content  mt-0">
		<section>
			<div class="page-header min-vh-100">
				<div class="container">
					<div class="row">
						<div
							class="col-6 d-lg-flex d-none h-100 my-auto pe-0 position-absolute top-0 start-0 text-center justify-content-center flex-column">
							<div
								class="position-relative bg-gradient-primary h-100 m-3 px-7 border-radius-lg d-flex flex-column justify-content-center"
								style="background-image: url('bootstrap/material/assets/img/illustrations/illustration-reset.jpg'); background-size: cover;">
							</div>
						</div>
						<div
							class="col-xl-5 col-lg-5 col-md-7 d-flex flex-column ms-auto me-auto ms-lg-auto me-lg-5">
							<div class="card card-plain">
								<div class="card-header">
									<h4 class="font-weight-bolder">회원가입</h4>
								
								<div class="card-body">
									<!-- 폼 -->
									<form role="form" method="post" id="frm">
									 <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
										<div class="input-group input-group-outline ">
											<input type="text" class="form-control " id="memberId" name="memberId" placeholder="아이디를 입력해주세요.">
										</div>
										<div>
											<label><small class="point mb-3 successIdChk">&nbsp;&nbsp;※ 영문자, 소문자 입력가능, 최대 10자까지 입력</small></label>
											<input type="hidden" id="idChk" value="false">
										</div>
										<div class="input-group input-group-outline mb-3">
											<input type="password" class="form-control" id="pw" name="pw" placeholder="비밀번호를 입력해주세요.">
										</div>
										<div class="input-group input-group-outline ">
											<input type="password" class="form-control" id="pwRe" name="pwRe" placeholder="비밀번호를 동일하게 한 번 더 입력하세요.">&nbsp;&nbsp;<br>
										</div>
										<div>
											<label><small class="point mb-3 successPwChk"></small></label>
											<input type="hidden" id="pwChk" value="false"/> 
										</div>
										<div class="input-group input-group-outline ">
											<input type="text" class="form-control" id="name" name="name" placeholder="이름을 입력하세요.">&nbsp;&nbsp;<br>
										</div>
										<div>
											<label><small class="point mb-3 successName">&nbsp;&nbsp;</small></label>
											<input type="hidden" id="nameChk" value="false"/> 
										</div>
										<div class="input-group input-group-outline ">
											<input type="text" class="form-control" id="nick" name="nick" placeholder="닉네임을 입력해주세요.">
										</div>
										<div>
											<input type="hidden" id="nickChk" value="false">
											<label><small class="point mb-3 successNickChk">&nbsp;&nbsp;</small></label>
										</div>
										<div class="input-group input-group-outline">
											<input type="text" class="form-control mb-0" id="email" name="email" placeholder="이메일을 입력해주세요.">
											<button type="button" class="btn btn-outline-info btn-sm mb-0" value="false" id="checkEmail">인증하기</button>&nbsp;&nbsp;<br>
										</div>
										<div>
											<label><small class="point mb-2 successEmailRegChk ">&nbsp;&nbsp;</small></label>
											<input type="hidden" id="emailRegChk" value="false">
										</div>
										<div class="input-group input-group-outline mb-2">
											<input type="text" class="form-control" id="inputCode" name="inputCode" placeholder="이메일 인증번호를 입력하세요.">
										</div>
										<div>
											<label><small class="point successEmailChk">&nbsp;&nbsp;</small></label>
											<input type="hidden" id="emailChk" value="false">
										</div>
										<div class="text-center">
											<button type="button" class="btn btn-info mr-1 mb-1" onclick="insertCall()">회원가입</button>
                       			            <button type="reset" class="btn btn-light-secondary mr-1 mb-1">초기화</button>
										</div>
									</form>
								</div>
								<div class="card-footer text-center pt-0 px-lg-2 px-1">
									<p class="mb-2 text-sm mx-auto">
										이미 계정이 있으신가요? <a href="/loginForm.do"
											class="text-info text-gradient font-weight-bold">로그인</a>
									</p>
								</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
	</main>
<script type="text/javascript">
	//아이디 중복체크
    $("#memberId").blur(function(){ //대상 엘리먼트가 포커스를 잃었을 때 이벤트를 처리하는 이벤트 핸들러
    	var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");
		
    	let mId = $("#memberId").val();
        if(mId == "" ||mId.length < 2){ // id 입력안했거나 2글자 이하
        	$(".successIdChk").text("* id를 다시 한 번 확인해주세요.");
			$(".successIdChk").css("color", "red");
			$("#idChk").val("false");
        }else{
        	$.ajax({
        		url : '/chk/ajaxIdChk.do',
        		type:'post',
        		data : {'mId' : mId},
        		beforeSend: function(xhr){
    		    	xhr.setRequestHeader(header, token);
    		    },
        		success: function(data){
        			if(data == 0){
 		       			$(".successIdChk").text("* 사용가능한 아이디입니다.");
 		       			$(".successIdChk").css("color","green");
 		       			$("#idChk").val("true");
        			}else{
        				$(".successIdChk").text("＊ 사용중인 아이디입니다.");
 		       			$(".successIdChk").css("color","red");
 		       			$("#idChk").val("false");
        			}
        			}, error : function() {
    					console.log("실패");
    				}
        	})
        }
    })
    //아이디 중복체크 끝
    
    //닉네임 중복체크
    $("#nick").blur(function(){ 
    	var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");
		
    	let mNick = $("#nick").val();
    	    mId = $("#memberId").val();
    	    
        if(mNick == ""){ // nick이 입력이 안 됐을 경우
        	$(".successNickChk").text("* 닉네임을 입력하세요.");
			$(".successNickChk").css("color", "red");
			$("#nickChk").val("false");
        }else{
        	$.ajax({
        		url : '/chk/ajaxNickChk.do',
        		type:'post',
        		data : {'mNick' : mNick},
        		beforeSend: function(xhr){
    		    	xhr.setRequestHeader(header, token);
    		    },
        		success: function(data){
        			console.log(data);
        			if(data == 0){
 		       			$(".successNickChk").text("* 사용가능한 닉네임입니다.");
 		       			$(".successNickChk").css("color","green");
 		       			$("#nickChk").val("true");
        			}else{
        				$(".successNickChk").text("＊ 사용중인 닉네임입니다.");
 		       			$(".successNickChk").css("color","red");
 		       			$("#nickChk").val("false");
        			}
        			}, error : function() {
    					console.log("실패");
    				}
        	})
        }
    })
    //닉네임 중복체크끝
    
    //비밀번호 확인
    $("#pwRe").blur(function(){ 
		
    	let mPw = $("#pw").val();
    	let mPwRe = $("#pwRe").val();
    	    
        if(mPw != "" & mPwRe !="" & mPw == mPwRe){ 
        	$(".successPwChk").text("* 비밀번호가 일치합니다.");
			$(".successPwChk").css("color", "green");
			$("#pwChk").val("true");
        
        }else{
        	$(".successPwChk").text("* 비밀번호가 일치하지 않습니다.");
			$(".successPwChk").css("color", "red");
			$("#pwChk").val("false");
        }
    })
    //비밀번호 확인끝
    
    //이름 확인
    $("#name").blur(function(){ 
		
    	let mName = $("#name").val();
    	    
        if(mName == "" || mName.length < 2 || mName.length > 5){ 
        	$(".successName").text("* 이름을 다시 입력하세요..");
			$(".successName").css("color", "red");
			$("#nameChk").val("false");
        
        }else{
        	$(".successName").text(" ");
			$("#nameChk").val("true");
        }
    })
    //이름 끝
    
    
    // 이메일 정규표현식 체크
	 $("#email").blur(function(){        
	    let email = $("#email").val();
	    let exptext = /^[A-Za-z0-9_\.\-]+@[A-Za-z0-9\-]+\.[A-Za-z0-9\-]+/;
	        if(exptext.test(email)==false){
	            //이메일 형식이 알파벳+숫자@알파벳+숫자.알파벳+숫자 형식이 아닐경우            
	            $(".successEmailRegChk").text("* 이메일 형식에 맞게 작성해주세요.");
			    $(".successEmailRegChk").css("color", "red");
			    $("#emailRegChk").val("false");
	        }else{
	        	$(".successEmailRegChk").text("");
				$("#emailRegChk").val("true");
	        }
	});
    
    // 이메일 인증번호
    $("#checkEmail").click(function(){
        var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");
        
        let mEmail = $("#email").val();
        if ($("#emailRegChk").val() == 'true'){
        	
	        $.ajax({
	            url: '/chk/ajaxMailChk.do',
	            type: 'post',
	            data :{ 'email' : mEmail },
	            beforeSend: function(xhr){
	    		    	xhr.setRequestHeader(header, token);
	    		    },
	            success : function(data){
	                alert("해당 이메일로 인증번호 발송이 완료되었습니다.");
	                console.log("data :"+data);
	                
	                chkEmailConfirm(data);
	            },error : function() {
					console.log("실패");
				}
	        })
        }else{
        	alert("이메일을 확인해주시기 바랍니다.")
        }
        
    })
    
    //이메일 인증번호 체크 함수
    function chkEmailConfirm(data){
    
        $("#inputCode").on("keyup", function(){ //코드입력 후...
    		let iCode = document.getElementById("inputCode").value;
            if(data != iCode){
                $(".successEmailChk").text("* 인증 코드가 맞지 않습니다.");
			    $(".successEmailChk").css("color", "red");
			    $("#emailChk").val("false");
            } else{
                $(".successEmailChk").text("* 인증번호 확인 완료");
			    $(".successEmailChk").css("color", "green");
			    $("#emailChk").val("true");
            }
            
        })
    }
    //이메일 인증번호 체크 함수
    
    
    // 회원가입 버튼
    function insertCall(){
    	console.log($("#idChk").val());
    	console.log($("#nickChk").val());
    	console.log($("#pwChk").val());
    	console.log($("#nameChk").val());
    	
    	if($("#idChk").val() == 'true' & $("#nickChk").val() == 'true' & $("#pwChk").val() =='true' & $("#nameChk").val() == 'true' & $("#emailChk").val() == 'true' 
    		&  $("#emailRegChk").val() =='true' &  $("#emailChk").val() == 'true'){
    		alert("회원가입 되었습니다!")
	    	frm.action="/memberInsert.do";
	    	frm.submit();
    	}else{
    		alert("회원가입이 처리가 되지 않았습니다. 값이 비어있거나 중복값을 확인해주세요.");
    	} 
    }
    //회원가입 끝
    
</script>
</body>
</html>