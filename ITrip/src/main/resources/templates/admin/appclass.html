<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">
<head>
<meta charset="UTF-8">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
<div  layout:fragment="content">
<!-- Table head options start -->
<div class="row" id="table-head">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h4 class="card-title">회원정보</h4>
      </div>
      <div class="card-content">
        <div class="card-body">
          <p>Class를 신청한 회원입니다. 권한을 수정해주세요.</p>
        </div>
        <!-- table head dark -->
        <div class="table-responsive">
          <table class="table table-light mb-0"> 
            <thead>
              <tr>
                <th>클래스제목</th>
                <th>가이드아이디</th>
                <th>업무 카테고리</th>
                <th>정원/수업횟수</th>
                <th>신청일자</th>
                <th>승인상태</th>
                <th>승인수정</th>
              </tr>
            </thead>
            <tbody th:each="classList : ${pageInfo.list}">
              <tr>
                <td class="text-bold-500" th:text="${classList.title}"></td>
                <td th:text="${classList.guideId}"></td>
                <td class="text-bold-500" th:text="${classList.cdName}"></td>
                <td class="text-bold-500" th:text="${classList.psncpa}+'명 / '+${classList.classCnt}+'주'"></td>
                <td class="text-bold-500" th:text="${classList.dt}"></td>
                <td class="text-bold-500" th:text="${classList.confmCd}"></td>
                <td th:id="${classList.classNo}">
                <input type="button" th:onclick="updateClass(this.getAttribute('id'))"
				class="btn btn-primary btn-l" value="수정" th:name="${classList.classNo}" th:id="${classList.classNo}">
				</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Table head options end -->
<!-- 페이지네이션 -->
			 <nav aria-label="Page navigation example">
				<ul class="pagination pagination-info  justify-content-center">
					<li class="page-item disabled"
						th:if="${pageInfo.isIsFirstPage()}"><span
						class="page-link">«</span></li>
					<li class="page-item"
						th:if="${!pageInfo.isIsFirstPage() && pageInfo.getList().size() > 0}"><a
						class="page-link"
						th:href="|javascript:gopage([[${pageInfo.getPrePage()}]])|"
						rel="prev">«</a></li>
					<li
						th:class="|page-item ${(pageInfo.pageNum eq page) ? 'active': ''} |"
						th:each="page:${pageInfo.navigatepageNums}"><span
						class="page-link" th:if="${pageInfo.pageNum eq page}"
						th:text="${page}"></span> <a class="page-link"
						th:unless="${pageInfo.pageNum eq page}"
						th:href="|javascript:gopage(${page})|" th:text="${page}">{{$page
							}}</a></li>
					<li class="page-item" th:if="${pageInfo.hasNextPage}"><a
						class="page-link"
						th:href="|javascript:gopage([[${pageInfo.getNextPage()}]])|"
						rel="next">»</a></li>
					<li class="page-item disabled"
						th:unless="${pageInfo.hasNextPage}"><span
						class="page-link">»</span></li>
				</ul>
			</nav> 
			<script type="text/javascript">
		 	function gopage(p) {
				location.href = '/appClass.do?pageNum=' + p;
			} 
			
		 	let token = $("meta[name='_csrf']").attr("content");
			let header = $("meta[name='_csrf_header']").attr("content");
			
			
			function updateClass(cNo) {
				// console.log(cNo);
				let modifyTd = document.getElementById(cNo); // id가 cNo랑 같은 td 꺽새
				// console.log(modifyTd);
				 modifyTd.previousElementSibling.innerText=""; // 승인대기글씨 비우기
				 
				// console.log(modifyTd.previousElementSibling); 
				let td = modifyTd.previousElementSibling; // 승인대기있는 td 꺽새
				
				let select = document.createElement('select'); // select태그 생성
				select.setAttribute('id','sel'); 
				select.setAttribute('class','form-select');
				select.setAttribute('style','width:100px');
				let author = ['승인수락','승인거절'];
				
				author.forEach(function (ath,idx) {
				//	console.log(ath); // 승인중,대기,수락,거절
				//	console.log(idx); // 0,1,2,3
					select.innerHTML += '<option value='+idx+'>' + ath + '</option>';
				})
				td.append(select);
				
				let btn = modifyTd.firstElementChild // id가 cNo랑 같은 td 꺽새안에 input
				// console.log(btn);
				btn.value='수정완료';
				
				let opVal = "";
				$("#sel").change(function() {
					opVal = $(this).val();
				//	console.log(opVal); // 승인중 :0, 대기:1, 수락:2, 거절:3
				})
				
				btn.addEventListener('click', function(e) {
					e.preventDefault(); // 브라우저 고유의 동작을 중단시켜주는 역할
					
					$.ajax({
						url:'/classUpdate.do',
						type:'post',
						data:{'classNo':cNo, 'confmCd':opVal},
						beforeSend:function(xhr) {
							xhr.setRequestHeader("AJAX", true);
						    xhr.setRequestHeader("X-CSRF-TOKEN", token);
						},
						success:function result(res){
							alert('수정완료');
							location.href="appClass.do";
						},
						error:function err(xhr,err) {
							alert('수정에러');
						}
					})
					
					
				})
				
				
				
			}
			
			
			</script>
			</div>
</body>
</html>